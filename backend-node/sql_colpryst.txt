-- Crear la base de datos y seleccionarla
create database colpryst_col3;
use colpryst_col3;

-- Crear tabla 'cargo'
create table cargo (
    id_cargo int auto_increment not null,
    nombre_cargo varchar(80) not null,
    descripcion varchar(80),
    constraint pk_cargo primary key (id_cargo)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_spanish2_ci;

-- Crear tabla 'usuario'
create table usuario (
    id_usuario int auto_increment not null,
    tipo_documento varchar(20) not null,
    numero_documento varchar(20) not null unique,
    nombre_empleado varchar(80) not null,
    direccion_empleado varchar(80),
    telefono_empleado varchar(80), 
    email_empleado varchar(80) not null unique,
    eps_empleado varchar(80),
    usuarioadmin varchar(80) unique,
    contrasenia varchar(100),
    id_cargo int not null,
    constraint pk_usuario primary key (id_usuario),
    constraint fk_usuario_cargo foreign key (id_cargo) references cargo (id_cargo)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_spanish2_ci;

-- Crear tabla 'reconocimiento_facial'
CREATE TABLE reconocimiento_facial (
    id_foto INT AUTO_INCREMENT NOT NULL,
    embedding LONGTEXT NOT NULL,  -- AquÃ­ se guarda el embedding como texto (ej: "[0.1, -0.2, ...]")
    id_usuario INT NOT NULL,
    CONSTRAINT pk_reconocimiento_facial PRIMARY KEY (id_foto),
    CONSTRAINT fk_reconocimiento_usuario FOREIGN KEY (id_usuario) REFERENCES usuario (id_usuario)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_spanish2_ci;

-- Crear tabla 'registro_entrada'
create table registro_entrada (
    id_entrada int auto_increment not null,
    fecha_hora datetime not null,
    comentarios varchar(500),
    id_usuario int not null,
    constraint pk_registro_entrada primary key (id_entrada),
    constraint fk_registro_usuario foreign key (id_usuario) references usuario (id_usuario)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_spanish2_ci;

-- Crear tabla 'notificacion_entrada_tarde'
create table notificacion_entrada_tarde (
    id_notificacion int auto_increment not null,
    id_entrada int not null,
    id_usuario int not null,
    estado boolean not null,
    fecha_hora datetime not null,
    comentarios varchar(500) not null,
    constraint pk_notificacion primary key (id_notificacion),
    constraint fk_notificacion_entrada foreign key (id_entrada) references registro_entrada (id_entrada)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_spanish2_ci;

-- Crear tabla 'registro_salida'
create table registro_salida (
    id_salida int auto_increment not null,
    fecha_hora datetime not null,
    comentarios varchar(500),
    id_usuario int not null,
    constraint pk_registro_salida primary key (id_salida),
    constraint fk_salida_usuario foreign key (id_usuario) references usuario (id_usuario)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_spanish2_ci;

-- Crear tabla 'notificacion_salida_temprana'
CREATE TABLE notificacion_salida_temprana (
    id_notificacion INT AUTO_INCREMENT NOT NULL,
    id_salida INT NOT NULL,
    id_usuario INT NOT NULL,
    estado BOOLEAN NOT NULL,
    fecha_hora DATETIME NOT NULL,
    comentarios VARCHAR(500) NOT NULL,
    CONSTRAINT pk_notificacion_salida PRIMARY KEY (id_notificacion),
    CONSTRAINT fk_notificacion_salida FOREIGN KEY (id_salida) REFERENCES registro_salida (id_salida),
    CONSTRAINT fk_notificacion_salida_usuario FOREIGN KEY (id_usuario) REFERENCES usuario (id_usuario)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_spanish2_ci;

-- tabal inasistencia
CREATE TABLE no_asistencia (
    id_inasistencia INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    fecha DATE NOT NULL,
    motivo VARCHAR(255) DEFAULT 'No marcÃ³ entrada',
    CONSTRAINT fk_no_asistencia_usuario FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_spanish2_ci;



/*--------------------------------------------------------------------------------------------------------------
-------------------------TRIGGER ENTRADA TARDE-------------------------*/

-- 	TRIGGER --- PARA LLEGADA TARDE DESPUES DE LAS 7:30
DELIMITER $$

CREATE TRIGGER notificar_llegada_tarde
AFTER INSERT ON registro_entrada
FOR EACH ROW
BEGIN
    -- Verifica si la hora de entrada es despuÃ©s de las 07:30 AM
    IF TIME(NEW.fecha_hora) > '07:15:00' THEN
        -- Inserta un registro en la tabla notificacion_entrada_tarde
        INSERT INTO notificacion_entrada_tarde (id_entrada, id_usuario, estado, fecha_hora, comentarios) 
        VALUES (
            NEW.id_entrada, 
            NEW.id_usuario, 
            FALSE,  -- Estado en false por defecto
            NEW.fecha_hora, 
            COALESCE(NEW.comentarios, 'Sin comentarios') -- Si comentarios es NULL, usa "Sin comentarios"
        );
    END IF;
END $$

DELIMITER ;

-- DROP TRIGGER IF EXISTS notificar_llegada_tarde;

/*--------------------------------------------------------------------------------------------------------------
-------------------------TRIGGER SALIDA TEMPRANA-------------------------*/

DELIMITER $$

CREATE TRIGGER notificar_salida_temprana
AFTER INSERT ON registro_salida
FOR EACH ROW
BEGIN
    -- Verifica si la hora de salida es antes de las 16:30 PM
    IF TIME(NEW.fecha_hora) < '16:30:00' THEN
        -- Inserta un registro en la tabla notificacion_salida_temprana
        INSERT INTO notificacion_salida_temprana (
            id_salida, 
            id_usuario, 
            estado, 
            fecha_hora, 
            comentarios
        ) VALUES (
            NEW.id_salida, 
            NEW.id_usuario, 
            FALSE,  -- Estado en false por defecto (no revisado)
            NEW.fecha_hora, 
            COALESCE(NEW.comentarios, 'Sin comentarios')
        );
    END IF;
END $$

DELIMITER ;


/*--------------------------------------------------------------------------------------------------------------*/
-- INSERT

INSERT INTO Cargo (nombre_cargo, descripcion) VALUES 
('Gerente', 'Gerente de operaciones'),
('Director', 'Director de la empresa'),
('Administrativo', 'AdministraciÃ³n general'),
('Desarrollador', 'Desarrollador de software'),
('Contador', 'Encargado de finanzas'),
('Soporte TÃ©cnico', 'Soporte de IT'),
('Marketing', 'Especialista en marketing'),
('Recursos Humanos', 'GestiÃ³n de personal'),
('Vendedor', 'Venta de productos'),
('Analista', 'Analista de datos');

-- InserciÃ³n de registros Ãºnicos por los tres primeros cargos
-- ðŸ“Œ Gerente (ID Cargo = 1)
INSERT INTO usuario (tipo_documento, numero_documento, nombre_empleado, direccion_empleado, telefono_empleado, email_empleado, eps_empleado, usuarioadmin, contrasenia, id_cargo)
VALUES
('DNI', '12345678A', 'Carlos PÃ©rez', 'Calle 123, Ciudad A', '3001234567', 'carlos.perez@colpryst.com', 'EPS001', 'carlos.perez', 'admin123', 1);

-- ðŸ“Œ Director (ID Cargo = 2)
INSERT INTO usuario (tipo_documento, numero_documento, nombre_empleado, direccion_empleado, telefono_empleado, email_empleado, eps_empleado, usuarioadmin, contrasenia, id_cargo)
VALUES
('DNI', '66677788Z', 'Laura Castillo', 'Avenida 101, Ciudad Z', '3166789012', 'laura.castillo@colpryst.com', 'EPS026', 'laura.castillo', 'director2024', 2);

-- ðŸ“Œ Administrativo (ID Cargo = 3)
INSERT INTO usuario (tipo_documento, numero_documento, nombre_empleado, direccion_empleado, telefono_empleado, email_empleado, eps_empleado, usuarioadmin, contrasenia, id_cargo)
VALUES
('DNI', '23456789B', 'Ana GÃ³mez', 'Avenida 456, Ciudad B', '3102345678', 'ana.gomez@colpryst.com', 'EPS002', 'ana.gomez', NULL, 3);

-- ðŸ“Œ Desarrolladores (ID Cargo = 4)
INSERT INTO usuario (tipo_documento, numero_documento, nombre_empleado, direccion_empleado, telefono_empleado, email_empleado, eps_empleado, usuarioadmin, contrasenia, id_cargo)
VALUES
('DNI', '56789012E', 'Jorge FernÃ¡ndez', 'Avenida 112, Ciudad E', '3405678901', 'jorge.fernandez@colpryst.com', 'EPS005', 'jorge.fernandez', NULL, 4),  

-- ðŸ“Œ Contadores (ID Cargo = 5)
('DNI', '78901234G', 'Juan LÃ³pez', 'Calle 415, Ciudad G', '3607890123', 'juan.lopez@colpryst.com', 'EPS007', 'juan.lopez', NULL, 5),  

-- ðŸ“Œ Soporte TÃ©cnico (ID Cargo = 6)
('DNI', '22222222L', 'Gabriel NÃºÃ±ez', 'Carrera 324, Ciudad L', '3022345678', 'gabriel.nunez@colpryst.com', 'EPS012', 'gabriel.nunez', NULL, 6),  

-- ðŸ“Œ Marketing (ID Cargo = 7)
('DNI', '55555555O', 'Marta Blanco', 'Carrera 101, Ciudad O', '3055678901', 'marta.blanco@colpryst.com', 'EPS015', 'marta.blanco', NULL, 7),  

-- ðŸ“Œ Recursos Humanos (ID Cargo = 8)
('DNI', '77777777Q', 'Rosa Delgado', 'Avenida 131, Ciudad Q', '3077890123', 'rosa.delgado@colpryst.com', 'EPS017', 'rosa.delgado', NULL, 8),  

-- ðŸ“Œ Vendedores (ID Cargo = 9)
('DNI', '22233344V', 'Alejandro Ortiz', 'Calle 221, Ciudad V', '3122345678', 'alejandro.ortiz@colpryst.com', 'EPS022', 'alejandro.ortiz', NULL, 9),  

-- ðŸ“Œ Analistas (ID Cargo = 10)
('DNI', '55566677Y', 'MartÃ­n Herrera', 'Calle 789, Ciudad Y', '3155678901', 'martin.herrera@colpryst.com', 'EPS025', 'martin.herrera', NULL, 10);


/****************************************************************************************
*********************************************************************************************/
-- Registros de ENTRADA del 2025-05-26 al 2025-05-30 (lunes a viernes)
INSERT INTO registro_entrada (fecha_hora, comentarios, id_usuario) VALUES
-- Lunes
('2025-05-26 07:00:00', 'Entrada normal', 1),
('2025-05-26 07:40:00', 'Llegada tarde por trÃ¡fico', 2),
('2025-05-26 07:10:00', 'Entrada normal', 3),
('2025-05-26 07:45:00', 'Retraso por transporte', 4),
('2025-05-26 07:05:00', 'Entrada normal', 5),
('2025-05-26 07:00:00', 'Entrada normal', 6),
('2025-05-26 07:50:00', 'Despertador no sonÃ³', 7),
('2025-05-26 07:20:00', 'Entrada normal', 8),
('2025-05-26 07:35:00', 'TrÃ¡fico intenso', 9),
('2025-05-26 07:00:00', 'Entrada normal', 10);

INSERT INTO registro_entrada (fecha_hora, comentarios, id_usuario) VALUES
-- Martes
('2025-05-27 07:05:00', 'Entrada normal', 1),
('2025-05-27 07:30:00', 'Entrada normal', 2),
('2025-05-27 07:40:00', 'Llegada tarde', 3),
('2025-05-27 07:00:00', 'Entrada normal', 4),
('2025-05-27 07:55:00', 'Retraso por clima', 5),
('2025-05-27 07:15:00', 'Entrada normal', 6),
('2025-05-27 07:00:00', 'Entrada normal', 7),
('2025-05-27 07:35:00', 'Retraso menor', 8),
('2025-05-27 07:25:00', 'Entrada normal', 9),
('2025-05-27 07:50:00', 'Problema de transporte', 10);

INSERT INTO registro_entrada (fecha_hora, comentarios, id_usuario) VALUES
-- MiÃ©rcoles
('2025-05-28 07:00:00', 'Entrada normal', 1),
('2025-05-28 07:35:00', 'Retraso por embotellamiento', 2),
('2025-05-28 07:05:00', 'Entrada normal', 3),
('2025-05-28 07:20:00', 'Entrada normal', 4),
('2025-05-28 07:45:00', 'Llegada tarde', 5),
('2025-05-28 07:00:00', 'Entrada normal', 6),
('2025-05-28 07:50:00', 'Accidente en carretera', 7),
('2025-05-28 07:10:00', 'Entrada normal', 8),
('2025-05-28 07:00:00', 'Entrada normal', 9),
('2025-05-28 07:40:00', 'Llegada tarde', 10);

INSERT INTO registro_entrada (fecha_hora, comentarios, id_usuario) VALUES
-- Jueves
('2025-05-29 07:00:00', 'Entrada normal', 1),
('2025-05-29 07:00:00', 'Entrada normal', 2),
('2025-05-29 07:35:00', 'TrÃ¡fico inesperado', 3),
('2025-05-29 07:10:00', 'Entrada normal', 4),
('2025-05-29 07:50:00', 'Llegada tarde', 5),
('2025-05-29 07:00:00', 'Entrada normal', 6),
('2025-05-29 07:15:00', 'Entrada normal', 7),
('2025-05-29 07:40:00', 'TrÃ¡fico pesado', 8),
('2025-05-29 07:00:00', 'Entrada normal', 9),
('2025-05-29 07:55:00', 'Despertador fallÃ³', 10),

-- Viernes con inasitencia 3 ultimos
('2025-05-30 07:00:00', 'Entrada normal', 1),
('2025-05-30 07:20:00', 'Entrada normal', 2),
('2025-05-30 07:45:00', 'LlegÃ³ tarde', 3),
('2025-05-30 07:00:00', 'Entrada normal', 4),
('2025-05-30 07:30:00', 'Entrada normal', 5),
('2025-05-30 07:55:00', 'TrÃ¡fico', 6),
('2025-05-30 07:10:00', 'Entrada normal', 7);


-- Registros de SALIDA del 2025-05-26 al 2025-05-30 (lunes a viernes)
INSERT INTO registro_salida (fecha_hora, comentarios, id_usuario) VALUES
-- Lunes
('2025-05-26 16:40:00', 'Salida normal', 1),
('2025-05-26 16:00:00', 'Cita mÃ©dica', 2),
('2025-05-26 16:35:00', 'Salida normal', 3),
('2025-05-26 15:50:00', 'Salida por asuntos personales', 4),
('2025-05-26 16:50:00', 'Salida normal', 5),
('2025-05-26 16:30:00', 'Salida normal', 6),
('2025-05-26 14:45:00', 'Emergencia familiar', 7),
('2025-05-26 16:40:00', 'Salida normal', 8),
('2025-05-26 16:00:00', 'Retiro anticipado por clima', 9),
('2025-05-26 16:45:00', 'Salida normal', 10),

-- Martes
('2025-05-27 16:30:00', 'Salida normal', 1),
('2025-05-27 16:45:00', 'Salida normal', 2),
('2025-05-27 15:30:00', 'Salida por reuniÃ³n externa', 3),
('2025-05-27 16:00:00', 'Salida justificada', 4),
('2025-05-27 16:40:00', 'Salida normal', 5),
('2025-05-27 16:50:00', 'Salida normal', 6),
('2025-05-27 16:30:00', 'Salida normal', 7),
('2025-05-27 14:30:00', 'Salida por consulta mÃ©dica', 8),
('2025-05-27 16:35:00', 'Salida normal', 9),
('2025-05-27 16:50:00', 'Salida normal', 10),

-- MiÃ©rcoles
('2025-05-28 16:30:00', 'Salida normal', 1),
('2025-05-28 16:00:00', 'Salida temprana justificada', 2),
('2025-05-28 15:45:00', 'Salida por enfermedad', 3),
('2025-05-28 16:45:00', 'Salida normal', 4),
('2025-05-28 16:50:00', 'Salida normal', 5),
('2025-05-28 16:20:00', 'Salida normal', 6),
('2025-05-28 14:50:00', 'Salida por asuntos personales', 7),
('2025-05-28 16:30:00', 'Salida normal', 8),
('2025-05-28 15:30:00', 'Salida justificada', 9),
('2025-05-28 16:40:00', 'Salida normal', 10),

-- Jueves
('2025-05-29 16:30:00', 'Salida normal', 1),
('2025-05-29 16:40:00', 'Salida normal', 2),
('2025-05-29 16:00:00', 'Salida anticipada', 3),
('2025-05-29 16:45:00', 'Salida normal', 4),
('2025-05-29 14:50:00', 'Cita mÃ©dica', 5),
('2025-05-29 16:35:00', 'Salida normal', 6),
('2025-05-29 16:20:00', 'Salida normal', 7),
('2025-05-29 15:50:00', 'Salida por asuntos legales', 8),
('2025-05-29 16:30:00', 'Salida normal', 9),
('2025-05-29 16:40:00', 'Salida normal', 10),

-- Viernes
('2025-05-30 16:30:00', 'Salida normal', 1),
('2025-05-30 16:45:00', 'Salida normal', 2),
('2025-05-30 16:50:00', 'Salida normal', 3),
('2025-05-30 16:30:00', 'Salida normal', 4),
('2025-05-30 14:30:00', 'Salida mÃ©dica', 5),
('2025-05-30 16:00:00', 'Salida justificada', 6),
('2025-05-30 16:50:00', 'Salida normal', 7),
('2025-05-30 16:30:00', 'Salida normal', 8),
('2025-05-30 16:40:00', 'Salida normal', 9),
('2025-05-30 15:20:00', 'Salida anticipada', 10);


/*--------------------------------------------------------------------------------------------------------------
-------------------------PROCEDIMIENTO INASISTENCIA-------------------------*/
DELIMITER $$

CREATE PROCEDURE registrar_inasistencias_por_fecha(IN fecha_in DATE)
BEGIN
  INSERT INTO no_asistencia (id_usuario, fecha)
  SELECT u.id_usuario, fecha_in
  FROM usuario u
  WHERE NOT EXISTS (
    SELECT 1
    FROM registro_entrada re
    WHERE re.id_usuario = u.id_usuario
      AND DATE(re.fecha_hora) = fecha_in
  );
END$$

DELIMITER ;

DROP PROCEDURE IF EXISTS registrar_inasistencias_por_fecha;

CALL registrar_inasistencias_por_fecha('2025-05-30'); -- cambiar fecha segun pruebas
